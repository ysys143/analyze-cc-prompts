# Claude Code 프롬프트 분석

Claude Code CLI v2.1.29에 내장된 모든 프롬프트 문자열을 추출하고 분석한 프로젝트.

---

## 0. 이 프로젝트에 대해

### 기존 접근 방식의 한계

그동안 "클로드 코드 시스템 프롬프트"라며 돌아다니는 장문의 자료들이 있었다. nginx reverse proxy로 API 요청을 후킹해서 캡처한 사례도 있다. 하지만 이런 방식으로 보이는 것은 **조립이 끝난 최종 결과물**일 뿐, 프롬프트가 어떻게 구성되고 조립되는지는 알 수 없다.

또한 Gemini CLI는 GitHub에 소스가 공개되어 있지만, Claude Code는 그렇지 않다. npm에 배포된 패키지를 보면 `cli.js`라는 단일 파일 하나에 번들링+난독화된 상태로 배포되어 있다.

### 이 프로젝트의 접근 방식

Claude Code 자체의 코드 분석 능력을 활용해 cli.js를 직접 분석했다. 난독화된 변수명을 추적하고, 함수 호출 관계를 파악하여 **소스코드 수준에서** 프롬프트를 추출했다. 이를 통해 다음을 확인할 수 있었다:

- 총 53개의 프롬프트가 내장되어 있다
- 하나의 거대한 시스템 프롬프트가 아니라, **18개 서브 함수가 상황에 따라 동적으로 조립**되는 모듈식 구조다
- system 필드 외에도 messages, tools 등 여러 채널을 통해 프롬프트가 주입된다
- 대화 제목 생성, 사용자 불만 감지 등 **사용자에게 보이지 않는 사이드카 호출**이 별도로 존재한다

### Soul Document와의 차이

이 분석은 Claude의 "soul document"와는 별개다. Soul document는 모델 자체에 내장된 성격, 가치관, 행동 원칙으로, API 파라미터로 전달되는 시스템 프롬프트가 아니라 **모델 가중치 안에 녹아든 암묵적 지식**의 형태로 존재한다.

이번에 추출한 것은 그 위에 얹어지는 **Claude Code라는 제품 레이어의 프롬프트** - 즉 도구 사용법, 코딩 지침, 에이전트 정의, 권한 시스템 등 CLI 도구로서의 행동을 규정하는 **명시적 지침**들이다.

```
+---------------------------------------------------------------+
|                                                               |
|  Claude 모델 (soul document)                                   |
|  - 성격, 가치관, 행동 원칙                                      |
|  - 모델 가중치에 내장 (암묵적)                                   |
|  - 학습 시점에 결정됨                                           |
|                                                               |
|  +-----------------------------------------------------------+|
|  |                                                           ||
|  |  Claude Code 제품 프롬프트 (이 프로젝트의 분석 대상)          ||
|  |  - 시스템 프롬프트, 에이전트, 도구, 스킬                     ||
|  |  - cli.js에 문자열로 내장 (명시적)                           ||
|  |  - 매 API 호출마다 전달됨                                   ||
|  |                                                           ||
|  |  +-------------------------------------------------------+||
|  |  |                                                       |||
|  |  |  사용자 지침 (CLAUDE.md)                                |||
|  |  |  - 프로젝트별/글로벌 설정                                |||
|  |  |  - 사용자가 직접 작성                                   |||
|  |  |  - 첫 번째 user 메시지로 주입                            |||
|  |  |                                                       |||
|  |  +-------------------------------------------------------+||
|  +-----------------------------------------------------------+|
+---------------------------------------------------------------+
```

soul이 '성격'이라면, 이 프로젝트에서 분석한 것은 '업무 매뉴얼'에 해당한다.

---

## 1. Claude Code 모듈 위치

### npm 글로벌 설치 경로

```
~/.nvm/versions/node/v20.18.1/lib/node_modules/@anthropic-ai/claude-code/
```

nvm을 사용하지 않는 경우 `npm root -g`로 글로벌 모듈 경로를 확인할 수 있다.

### 디렉토리 구조

```
@anthropic-ai/claude-code/
├── cli.js              # 핵심 파일. 모든 로직과 프롬프트가 번들링된 단일 파일 (~11MB)
├── package.json        # 버전 정보, 의존성
├── vendor/             # 서드파티 라이브러리 (ripgrep 바이너리 등)
├── scripts/            # 설치 스크립트
└── node_modules/       # 의존성 모듈
```

**핵심:** Claude Code의 모든 동작은 `cli.js` 하나에 번들링되어 있다. 시스템 프롬프트, 에이전트 정의, 도구 설명, 스킬 프롬프트, 권한 시스템 등이 전부 이 파일 안에 있다.

---

## 2. cli.js 파일 구조

| 항목 | 값 |
|------|-----|
| 버전 | 2.1.29 |
| 빌드 시간 | 2026-01-31T20:12:07Z |
| 파일 크기 | ~11MB |
| 총 라인 수 | 6,428줄 |
| 형태 | 미니파이/번들링된 JavaScript (webpack 또는 esbuild 출력) |

### 라인별 대략적 구성

| 라인 범위 | 내용 |
|-----------|------|
| 1-450 | 모듈 시스템, 의존성 로딩, 유틸리티 함수 |
| 450-530 | 도구(Tool) 설명 정의 (Read, Write, Glob, Grep, WebFetch, WebSearch) |
| 1090-1375 | 에이전트(Agent) 시스템 프롬프트 (Bash, General-Purpose, Statusline, Explore, Plan, Guide) |
| 1615-1715 | 컴팩션(Compaction) / 대화 요약 프롬프트 |
| 2890-3010 | 팀 협업, 플랜 승인 프로토콜, 세션 노트 |
| 3340-3420 | Bash 도구 상세 설명 (Git 안전 프로토콜 포함) |
| 3570-3590 | 파일 경로 추출 프롬프트 |
| 3995-4010 | 세션 검색 / 관련성 판별 프롬프트 |
| 4012-4080 | 코드 리뷰, 보안 리뷰 스킬 프롬프트 |
| 4295-4370 | 에이전트 생성 아키텍트 프롬프트, 에이전트 스키마 |
| 4520-4610 | **메인 시스템 프롬프트** (핵심. 7개 서브 함수로 모듈식 조립) |
| 4850-4870 | Bash 명령어 분류/접두사 추출 프롬프트 |
| 4860-4930 | 출력 스타일 (Explanatory, Learning, 커스텀 스타일) |
| 5080-5100 | 팀 코디네이션 프롬프트 |
| 5190-5200 | 대화 제목 생성 프롬프트 |
| 5280-5310 | Magic Docs 업데이트 프롬프트 |
| 5312-5325 | 세션 품질 분류기 (사용자 불만 감지) |
| 5322-5440 | Remember 스킬 프롬프트 |
| 5435-5445 | Chrome-in-Browser 스킬 프롬프트 |
| 5676-5800 | 설정 업데이트 스킬 프롬프트 |
| 5810-5830 | 키바인딩 헬프 스킬 프롬프트 |
| 5830-6075 | 검증(Verification) 스킬 프롬프트 |
| 6084-6092 | 권한 설명기(Permission Explainer) 프롬프트 |

### 변수명 난독화

미니파이로 인해 모든 변수명이 축약되어 있다:

| 난독화된 변수 | 실제 용도 |
|--------------|----------|
| `IsY` | 메인 시스템 프롬프트 조립 함수 |
| `xsY`, `bsY`, `usY`, `msY`, `gsY`, `FsY`, `BsY` | 시스템 프롬프트 섹션별 서브 함수 |
| `YIA` | 보안 정책 프롬프트 |
| `oL9` | Bash 에이전트 프롬프트 |
| `d26` | General-Purpose 에이전트 프롬프트 |
| `Gt7` | Statusline 에이전트 프롬프트 |
| `aL9` | Explore 에이전트 프롬프트 |
| `sL9` | Plan 에이전트 프롬프트 |
| `AR9` | Claude Guide 에이전트 프롬프트 |
| `CrY` | 에이전트 생성 아키텍트 프롬프트 |
| `Jr4` | Bash 도구 설명 함수 |
| `wVY` | 세션 메모리 업데이트 프롬프트 |
| `JAz` | 세션 품질 분류기 |
| `RAz` | Remember 스킬 프롬프트 |
| `xAz` | 설정 업데이트 스킬 프롬프트 |
| `sAz` | 검증 스킬 프롬프트 |

---

## 3. 프롬프트 추출 방법

### 3.1 프롬프트 패턴 식별

cli.js에서 프롬프트는 다음 패턴으로 존재한다:

```javascript
// 패턴 1: 문자열 상수
const oL9 = "You are a command execution specialist for Claude Code..."

// 패턴 2: 함수 반환값 (동적 조립)
function IsY(A) {
  return `You are an interactive CLI tool that helps users ${A !== null ? '...' : '...'}`
}

// 패턴 3: 템플릿 리터럴 내 변수 삽입
`You are a teammate in team '${teamName}'. Your identity is '${selfAgentName}'.`

// 패턴 4: 스킬 등록 시 getPromptForCommand 콜백
zR({ name: "review", getPromptForCommand: () => "You are an expert code reviewer..." })
```

### 3.2 검색에 사용한 키워드

```
"You are"              → 에이전트/페르소나 프롬프트의 시작 패턴
"systemPrompt"         → 에이전트 정의에서 시스템 프롬프트 필드
"getPromptForCommand"  → 스킬 프롬프트 정의
"IMPORTANT:"           → 강조/제약 조건 프롬프트
"# "                   → 마크다운 형식의 프롬프트 (스킬에 많음)
"<example>"            → 예시 포함 프롬프트
```

### 3.3 추출 과정

1. **모듈 경로 확인**: `npm root -g`로 글로벌 설치 경로를 찾고, `@anthropic-ai/claude-code/cli.js` 위치 확인
2. **파일 구조 파악**: 6,428줄 중 프롬프트가 집중된 영역을 Grep으로 탐색
3. **라인 범위별 읽기**: 미니파이된 파일은 한 줄이 수천~수만 자이므로 offset/limit를 지정해 구간별로 읽음
4. **프롬프트 식별**: 위 패턴들을 기준으로 프롬프트 문자열 경계를 파악
5. **카테고리 분류**: 용도별로 8개 카테고리로 분류하여 마크다운 파일로 저장

### 3.4 주의사항

- cli.js는 미니파이되어 있어 한 줄에 수천 자가 포함될 수 있다. 일반 텍스트 에디터로 열면 느려질 수 있으므로 라인 범위를 지정해서 읽는 것이 좋다.
- 템플릿 리터럴 내 `${}` 삽입 부분은 런타임에 동적으로 채워지는 값이다 (날짜, 모델명, 프로젝트 경로 등).
- 버전 업데이트 시 라인 번호가 변경될 수 있으므로 키워드 기반 검색을 병행해야 한다.

---

## 4. 추출된 파일 목록

| # | 파일 | 설명 |
|---|------|------|
| 01 | [01-main-system-prompt.md](01-main-system-prompt.md) | 핵심 시스템 프롬프트: 톤, 스타일, 전문성, 작업 관리, 도구 사용 정책 |
| 02 | [02-agent-prompts.md](02-agent-prompts.md) | 내장 에이전트 프롬프트: Bash, General-Purpose, Statusline, Explore, Plan |
| 03 | [03-tool-descriptions.md](03-tool-descriptions.md) | 도구 설명: Read, Write, Edit, Glob, Grep, Bash, WebFetch, WebSearch, Task 등 |
| 04 | [04-internal-prompts.md](04-internal-prompts.md) | 내부 운영 프롬프트: 컴팩션/요약, 세션 노트, 파일 경로 추출, 세션 검색 |
| 05 | [05-personas-and-styles.md](05-personas-and-styles.md) | 출력 스타일: 기본, Explanatory, Learning, 커스텀 스타일 로딩 |
| 06 | [06-code-review-and-security.md](06-code-review-and-security.md) | 코드 리뷰, 보안 리뷰 스킬 프롬프트 |
| 07 | [07-team-and-collaboration.md](07-team-and-collaboration.md) | 팀 메시징, 플랜 승인, 멀티 에이전트 협업 프로토콜 |
| 08 | [08-retry-and-error-handling.md](08-retry-and-error-handling.md) | 권한 시스템, 샌드박스, 에러 처리, 재시도 로직 |
| 09 | [09-api-call-structure.md](09-api-call-structure.md) | 실제 API 호출 메시지 구조: 요청 조립, 스트리밍, 캐시, 전체 예시 |

---

## 5. 프롬프트 아키텍처 요약

Claude Code는 계층적 프롬프트 시스템을 사용한다:

```
┌─────────────────────────────────────────┐
│  메인 시스템 프롬프트 (IsY 함수)           │
│  ├── 톤/스타일 (xsY)                     │
│  ├── 작업 관리 (bsY)                     │
│  ├── 질문 안내 (usY)                     │
│  ├── 코딩 지침 (msY)                     │
│  ├── 도구 사용 정책 (gsY)                 │
│  ├── 컨텍스트/환경 정보 (FsY)              │
│  └── 훅 시스템 (BsY)                     │
├─────────────────────────────────────────┤
│  도구 설명 (각 도구별 description 필드)     │
│  ├── Bash (Jr4) - Git 안전 프로토콜 포함   │
│  ├── Read, Write, Edit, Glob, Grep       │
│  ├── WebFetch, WebSearch                 │
│  └── Task, NotebookEdit, TodoWrite       │
├─────────────────────────────────────────┤
│  에이전트 프롬프트 (역할별 시스템 프롬프트)   │
│  ├── Bash (oL9) - 명령 실행 전문          │
│  ├── General-Purpose (d26) - 범용         │
│  ├── Statusline (Gt7) - 상태줄 설정       │
│  ├── Explore (aL9) - READ-ONLY 탐색      │
│  ├── Plan (sL9) - READ-ONLY 설계         │
│  ├── Guide (AR9) - 문서 안내              │
│  └── Agent Creator (CrY) - 동적 에이전트  │
├─────────────────────────────────────────┤
│  스킬 프롬프트 (작업별 특화 프롬프트)        │
│  ├── 코드 리뷰, 보안 리뷰                 │
│  ├── Remember, 설정 업데이트              │
│  ├── 검증(Verification), 키바인딩          │
│  └── Chrome-in-Browser, Magic Docs       │
├─────────────────────────────────────────┤
│  내부 운영 프롬프트                       │
│  ├── 컴팩션/요약, 세션 노트 업데이트        │
│  ├── 파일 경로 추출, 세션 검색             │
│  ├── 대화 제목 생성, 품질 분류             │
│  └── 권한 설명기, 명령어 분류              │
└─────────────────────────────────────────┘
```

### API 호출 시 메시지 배치 구조

위 프롬프트들이 하나의 API 호출에서 어떻게 배치되는지:

```
+=====================================================================+
|                  POST /v1/messages (단일 API 호출)                    |
+=====================================================================+
|                                                                     |
|  model: "claude-opus-4-5-20251101"                                  |
|                                                                     |
|  +----- system (content block 배열) ----------------------------+   |
|  |                                                              |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | [블록 0] 핵심 시스템 프롬프트          cache: global      |  |   |
|  |  |  "You are Claude Code, Anthropic's official CLI..."     |  |   |
|  |  |  + 톤/스타일 + 전문성 + 시간추정금지 + 작업관리          |  |   |
|  |  |  + 코딩지침 + 보안정책 + 훅시스템                        |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | [블록 1] 도구 사용 정책 + 코드 참조 형식                   |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | [블록 2] 스킬/슬래시 커맨드 목록                           |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | [블록 3] 환경 정보                    cache: ephemeral   |  |   |
|  |  |  CWD, OS, 날짜, 모델명, git 상태                        |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | [블록 4] MCP 서버 지침 (연결된 경우만)                     |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  +--------------------------------------------------------------+   |
|                                                                     |
|  +----- messages (대화 배열) -----------------------------------+   |
|  |                                                              |   |
|  |  [0] user: CLAUDE.md 주입                                    |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | <system-reminder>                                       |  |   |
|  |  |   Contents of /project/CLAUDE.md:                       |  |   |
|  |  |   ...프로젝트 지침...                                    |  |   |
|  |  |                                                         |  |   |
|  |  |   Contents of ~/.claude/CLAUDE.md:                      |  |   |
|  |  |   ...글로벌 지침...                                      |  |   |
|  |  | </system-reminder>                                      |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  [1] user: 사용자 첫 입력                                    |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | "src/index.ts 파일 읽어줘"                                |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  [2] assistant: 모델 응답                                    |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | thinking: "사용자가 파일을 읽어달라고..."                   |  |   |
|  |  | text: "파일을 읽어보겠습니다."                              |  |   |
|  |  | tool_use: { name:"Read", input:{file_path:"..."} }      |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  [3] user: 도구 결과 (자동 삽입)                              |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | tool_result: "  1  import express from 'express';\n..." |  |   |
|  |  | text: "<system-reminder>도구 관련 알림</system-reminder>"|  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  [4] assistant: 후속 응답                                    |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | thinking: "파일 내용을 분석하면..."                        |  |   |
|  |  | text: "이 파일은 Express 서버 진입점입니다..."              |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  [5] user: 다음 입력                     cache: ephemeral   |   |
|  |  +--------------------------------------------------------+  |   |
|  |  | "이 파일에서 에러 처리 부분 수정해줘"                       |  |   |
|  |  +--------------------------------------------------------+  |   |
|  |                                                              |   |
|  |  ... (턴이 쌓일수록 messages 배열 증가)                       |   |
|  |                                                              |   |
|  +--------------------------------------------------------------+   |
|                                                                     |
|  +----- tools (도구 스키마 배열) --------------------------------+   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  |  | Read     |  | Bash     |  | Edit     |  | Write    |      |   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  |  | Glob     |  | Grep     |  | Task     |  | WebFetch |      |   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  |  | WebSearch|  | TodoWrite|  | AskUser  |  | Notebook |      |   |
|  |  +----------+  +----------+  +----------+  +----------+      |   |
|  +--------------------------------------------------------------+   |
|                                                                     |
|  max_tokens: 16384                                                  |
|  thinking: { type: "enabled", budget_tokens: 10240 }                |
|  stream: true                                                       |
|                                                                     |
+=====================================================================+
```

상세 구조는 [09-api-call-structure.md](09-api-call-structure.md) 참조.

### 발견된 총 프롬프트 수: 약 53개

| 카테고리 | 개수 |
|----------|------|
| 시스템 프롬프트 (메인 + 서브) | 9 |
| 에이전트 프롬프트 | 7 |
| 도구 설명 | 12 |
| 출력 스타일/페르소나 | 4 |
| 스킬 프롬프트 | 8 |
| 내부 운영 프롬프트 | 13 |

---

## 면책 조항

이 분석은 교육 및 연구 목적으로 수행되었다. 프롬프트는 공개 배포된 npm 패키지 `@anthropic-ai/claude-code` v2.1.29에서 추출되었다.
